<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DraftKings NFL Showdown Lineup Database</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div id="app" class="min-h-screen p-4">
        <div class="max-w-7xl mx-auto">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">DraftKings NFL Showdown Lineup Database</h1>
                <p class="text-gray-600 mb-6" id="status">Loading data...</p>

                <div class="relative mb-4" id="searchContainer" style="display:none;">
                    <input type="text" id="searchInput" placeholder="Search players, teams, positions..." 
                           class="w-full pl-4 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>

                <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4" id="filterContainer" style="display:none;">
                    <select id="favoriteUnderdogFilter" class="px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="">All (Favorite/Underdog)</option>
                        <option value="Favorite">Favorite Only</option>
                        <option value="Underdog">Underdog Only</option>
                    </select>

                    <select id="positionFilter" class="px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="">All Positions</option>
                    </select>

                    <select id="teamFilter" class="px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="">All Teams</option>
                    </select>

                    <select id="gameFilter" class="px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="">All Games</option>
                    </select>

                    <button id="clearBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                        Clear All
                    </button>
                </div>

                <div id="resultCount" class="text-gray-600 text-center font-semibold mb-4"></div>
            </div>

            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-800 text-white">
                            <tr id="tableHeader"></tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                <div id="noResults" class="hidden text-center py-12 text-gray-500">
                    <p class="text-lg font-semibold">No results found</p>
                    <p class="text-sm">Try adjusting your filters or search term</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let columns = [];
        let filteredData = [];
        let sortConfig = { key: null, direction: 'asc' };

        function parseCSV(text) {
            const lines = text.split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = lines[i].split(',');
                const row = {};
                
                headers.forEach((header, index) => {
                    let value = values[index] ? values[index].trim() : '';
                    const numValue = parseFloat(value);
                    row[header] = !isNaN(numValue) && value !== '' ? numValue : value;
                });
                
                data.push(row);
            }

            return { headers, data };
        }

        function formatValue(value, columnName) {
            if (value === null || value === undefined || value === '') return '';
            
            // Format salary columns as currency
            if (columnName === 'Salary' || columnName === 'CPTSalary') {
                return '$' + Number(value).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            }
            
            // Format ownership columns as percentage
            if (columnName === 'ActualOwn' || columnName.toLowerCase().includes('ownership')) {
                return (Number(value) * 100).toFixed(1) + '%';
            }
            
            // Format Year column to remove decimals
            if (columnName === 'Year') {
                return Math.floor(Number(value)).toString();
            }
            
            // Format other numeric values
            if (typeof value === 'number') {
                return value.toFixed(2);
            }
            
            return value;
        }

        async function loadData() {
            try {
                console.log('Starting to load data...');
                document.getElementById('status').textContent = 'Loading data from GitHub...';
                
                const response = await fetch('https://raw.githubusercontent.com/cmain101/Showdown-Data/main/ETR_DK_showdown_data_total.csv');
                
                console.log('Fetch response status:', response.status);
                
                if (!response.ok) {
                    throw new Error('Failed to load CSV file: ' + response.status);
                }
                
                const csvText = await response.text();
                console.log('CSV loaded, length:', csvText.length);
                
                const parsed = parseCSV(csvText);
                console.log('Parse complete!');
                console.log('Total rows:', parsed.data.length);
                console.log('Headers:', parsed.headers);
                console.log('First row:', parsed.data[0]);
                
                allData = parsed.data;
                columns = parsed.headers;
                
                if (allData.length > 0) {
                    console.log('Initializing UI with', allData.length, 'rows');
                    initializeUI();
                    populateFilters();
                    renderTable();
                    document.getElementById('status').textContent = 
                        'Search and filter through ' + allData.length.toLocaleString() + ' lineup entries';
                } else {
                    document.getElementById('status').textContent = 'No data found in CSV';
                }
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('status').textContent = 'Error loading data: ' + error.message;
            }
        }

        function initializeUI() {
            console.log('Initializing UI...');
            document.getElementById('searchContainer').style.display = 'block';
            document.getElementById('filterContainer').style.display = 'grid';
            
            const headerRow = document.getElementById('tableHeader');
            headerRow.innerHTML = columns.map(col => 
                '<th onclick="sortTable(\'' + col.replace(/'/g, "\\'") + '\')" class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider cursor-pointer hover:bg-gray-700 whitespace-nowrap">' + 
                col + ' â†•</th>'
            ).join('');

            document.getElementById('searchInput').addEventListener('input', renderTable);
            document.getElementById('favoriteUnderdogFilter').addEventListener('change', renderTable);
            document.getElementById('positionFilter').addEventListener('change', renderTable);
            document.getElementById('teamFilter').addEventListener('change', renderTable);
            document.getElementById('gameFilter').addEventListener('change', renderTable);
            document.getElementById('clearBtn').addEventListener('click', clearFilters);
        }

        function populateFilters() {
            console.log('Populating filters...');
            
            // Get unique positions from the Position column (not Position(s))
            const positions = [...new Set(allData.map(r => r['Position']).filter(Boolean))].sort();
            
            const teams = [...new Set(allData.map(r => r['Team']).filter(Boolean))].sort();
            const games = [...new Set(allData.map(r => r['Game']).filter(Boolean))].sort();

            console.log('Unique positions:', positions.length);
            console.log('Unique teams:', teams.length);
            console.log('Unique games:', games.length);

            document.getElementById('positionFilter').innerHTML = '<option value="">All Positions</option>' +
                positions.map(p => '<option value="' + p + '">' + p + '</option>').join('');
            
            document.getElementById('teamFilter').innerHTML = '<option value="">All Teams</option>' +
                teams.map(t => '<option value="' + t + '">' + t + '</option>').join('');
            
            document.getElementById('gameFilter').innerHTML = '<option value="">All Games</option>' +
                games.map(g => '<option value="' + g + '">' + g + '</option>').join('');
        }

        function getFilteredData() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const favUnderdogFilter = document.getElementById('favoriteUnderdogFilter').value;
            const posFilter = document.getElementById('positionFilter').value;
            const teamFilter = document.getElementById('teamFilter').value;
            const gameFilter = document.getElementById('gameFilter').value;

            return allData.filter(row => {
                const matchesSearch = !search || Object.values(row).some(val =>
                    String(val).toLowerCase().includes(search)
                );
                
                // Filter by Favorite/Underdog using Favorite_Underdog column
                const favUnderdog = String(row['Favorite_Underdog'] || '');
                const matchesFavUnderdog = !favUnderdogFilter || favUnderdog === favUnderdogFilter;
                
                // Filter by position using Position column
                const matchesPos = !posFilter || String(row['Position'] || '') === posFilter;
                
                const matchesTeam = !teamFilter || String(row['Team'] || '').includes(teamFilter);
                const matchesGame = !gameFilter || String(row['Game'] || '') === gameFilter;

                return matchesSearch && matchesFavUnderdog && matchesPos && matchesTeam && matchesGame;
            });
        }

        function sortTable(key) {
            if (sortConfig.key === key) {
                sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortConfig.key = key;
                sortConfig.direction = 'asc';
            }
            renderTable();
        }

        function renderTable() {
            console.log('Rendering table...');
            filteredData = getFilteredData();

            if (sortConfig.key) {
                filteredData.sort((a, b) => {
                    const aVal = a[sortConfig.key];
                    const bVal = b[sortConfig.key];
                    
                    if (typeof aVal === 'number' && typeof bVal === 'number') {
                        return sortConfig.direction === 'asc' ? aVal - bVal : bVal - aVal;
                    }
                    
                    const aStr = String(aVal || '').toLowerCase();
                    const bStr = String(bVal || '').toLowerCase();
                    
                    if (sortConfig.direction === 'asc') {
                        return aStr < bStr ? -1 : aStr > bStr ? 1 : 0;
                    } else {
                        return aStr > bStr ? -1 : aStr < bStr ? 1 : 0;
                    }
                });
            }

            document.getElementById('resultCount').textContent = 
                'Showing ' + filteredData.length.toLocaleString() + ' of ' + allData.length.toLocaleString() + ' results';

            const tbody = document.getElementById('tableBody');
            const noResults = document.getElementById('noResults');

            if (filteredData.length === 0) {
                tbody.innerHTML = '';
                noResults.classList.remove('hidden');
            } else {
                noResults.classList.add('hidden');
                const displayData = filteredData.slice(0, 1000);
                tbody.innerHTML = displayData.map(row =>
                    '<tr class="hover:bg-gray-50">' +
                    columns.map(col => {
                        const val = row[col];
                        const display = formatValue(val, col);
                        return '<td class="px-4 py-3 text-sm text-gray-700 whitespace-nowrap">' + display + '</td>';
                    }).join('') +
                    '</tr>'
                ).join('');
                
                console.log('Table rendered with', displayData.length, 'rows');
            }
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('favoriteUnderdogFilter').value = '';
            document.getElementById('positionFilter').value = '';
            document.getElementById('teamFilter').value = '';
            document.getElementById('gameFilter').value = '';
            renderTable();
        }

        loadData();
    </script>
</body>
</html>
